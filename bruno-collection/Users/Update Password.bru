meta {
  name: Update Password
  type: http
  seq: 4
}

put {
  url: {{baseUrl}}/{{apiVersion}}/users/me/password
  body: json
  auth: bearer
}

headers {
  Content-Type: application/json
  X-Request-ID: {{$guid}}
  Authorization: Bearer {{actualuser.accessToken}}
}

auth:bearer {
  token: {{actualuser.accessToken}}
}

body:json {
  {
    "currentPassword": "{{actualuser.password}}",
    "newPassword": "{{actualuser.newPassword}}"
  }
}

script:pre-request {
  // Pre-request script for Update Password API
  console.log('ğŸ” Starting Update Password API request...');
  
  // Check if access token exists
  const accessToken = bru.getEnvVar('actualuser.accessToken');
  if (!accessToken || accessToken === 'your-access-token-here') {
    console.warn('âš ï¸  Warning: No valid access token found. Please login first.');
    console.log('Setting default token placeholder for testing...');
    bru.setEnvVar('actualuser.accessToken', 'your-access-token-here', { persist: true });
  } else {
    console.log('âœ… Access token found, proceeding with password update...');
  }
  
  // Check token expiry if available
  const tokenExpiry = bru.getEnvVar('actualuser.tokenExpiry');
  if (tokenExpiry) {
    const expiryTime = new Date(tokenExpiry);
    const currentTime = new Date();
    
    if (currentTime >= expiryTime) {
      console.warn('âš ï¸  Warning: Access token may be expired. Consider refreshing the token.');
    } else {
      console.log('âœ… Access token is still valid.');
    }
  }
  
  // Set default values if environment variables don't exist
  const currentPassword = bru.getEnvVar('actualuser.password');
  const newPassword = bru.getEnvVar('actualuser.newPassword');
  
  if (!currentPassword) {
    console.log('âš ï¸  Setting default current password for testing...');
    bru.setEnvVar('actualuser.password', 'SecurePass123@', { persist: true });
  } else {
    console.log('âœ… Using existing current password from environment');
  }
  
  if (!newPassword) {
    console.log('âš ï¸  Setting default new password for testing...');
    bru.setEnvVar('actualuser.newPassword', 'NewSecurePass123@', { persist: true });
  } else {
    console.log('âœ… Using existing new password from environment');
  }
  
  console.log('ğŸ”‘ Password update request prepared successfully');
}

script:post-response {
  // Post-response script for Update Password API
  console.log('ğŸ“¥ Processing Update Password API response...');
  
  try {
    const responseData = res.getBody();
    console.log('ğŸ“Š Response status:', res.status);
    
    if (res.status === 200 && responseData.success) {
      console.log('âœ… Password updated successfully!');
      console.log('ğŸ“Š Full response data:', JSON.stringify(responseData, null, 2));
      
      // Update the password in environment variables
      const newPassword = bru.getEnvVar('actualuser.newPassword');
      if (newPassword) {
        // Replace the old password with the new password
        bru.setEnvVar('actualuser.password', newPassword, { persist: true });
        console.log('ğŸ’¾ Updated actualuser.password to new password value');
        
        // Also update confirmPassword to match
        bru.setEnvVar('actualuser.confirmPassword', newPassword, { persist: true });
        console.log('ğŸ’¾ Updated actualuser.confirmPassword to match new password');
        
        // Clear the newPassword field since it's now the current password
        bru.setEnvVar('actualuser.newPassword', '', { persist: true });
        console.log('ğŸ§¹ Cleared actualuser.newPassword field');
      }
      
      // Handle session invalidation
      if (responseData.data && responseData.data.sessionsInvalidated) {
        console.log('âš ï¸  All user sessions have been invalidated for security.');
        console.log('ğŸ’¡ You may need to login again after this password change.');
        
        // Clear access tokens since sessions are invalidated
        bru.setEnvVar('actualuser.accessToken', '', { persist: true });
        bru.setEnvVar('actualuser.refreshToken', '', { persist: true });
        bru.setEnvVar('actualuser.isLoggedIn', 'false', { persist: true });
        console.log('ğŸ§¹ Cleared authentication tokens due to session invalidation');
      }
      
      console.log('ğŸ‰ Password updated and environment variables synchronized successfully');
      
    } else if (res.status === 401) {
      console.error('âŒ Authentication failed. Token may be expired or invalid.');
      console.error('ğŸ“„ Error response:', responseData);
      console.log('ğŸ’¡ Please login again to get a fresh token.');
      
    } else if (res.status === 400) {
      console.error('âŒ Bad request. Check the password requirements.');
      console.error('ğŸ“„ Error response:', responseData);
      
      if (responseData.error) {
        console.error('ğŸš¨ Error message:', responseData.error);
        
        // Common password update errors with helpful tips
        if (responseData.error.includes('Current password is incorrect')) {
          console.error('ğŸ’¡ Tip: Make sure you entered your current password correctly.');
        } else if (responseData.error.includes('New password must be different')) {
          console.error('ğŸ’¡ Tip: Your new password must be different from your current password.');
        } else if (responseData.error.includes('password must be at least')) {
          console.error('ğŸ’¡ Tip: Check password strength requirements (8+ chars, uppercase, lowercase, number, special char).');
        }
      }
      
      if (responseData.details && responseData.details.errors) {
        console.error('ğŸ“ Validation errors:', responseData.details.errors);
      }
      
    } else if (res.status === 422) {
      console.error('âŒ Validation failed. Check the password format and requirements.');
      console.error('ğŸ“„ Error response:', responseData);
      
      if (responseData.errors) {
        console.error('ğŸ“ Validation errors:', responseData.errors);
      }
      
    } else if (res.status >= 400) {
      console.error('âŒ Password update failed with status:', res.status);
      console.error('ğŸ“„ Error response:', responseData);
      
      if (responseData.error) {
        console.error('ğŸš¨ Error message:', responseData.error);
      }
    }
    
  } catch (error) {
    console.error('ğŸ’¥ Error processing password update response:', error.message);
    console.error('ğŸ“„ Raw response:', res.body);
  }
  
  console.log('ğŸ Update Password API response processing completed');
}

tests {
  test("Status should be 200 for successful password update", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Response should have success property", function() {
    expect(res.body).to.have.property('success');
  });
  
  test("Response should be successful", function() {
    expect(res.body.success).to.be.true;
  });
  
  test("Response should have a message", function() {
    expect(res.body).to.have.property('data');
    expect(res.body.data).to.have.property('message');
  });
  
  test("Password update message should be present", function() {
    if (res.status === 200) {
      expect(res.body.data.message).to.include('Password');
    }
  });
}

docs {
  # Update Password API
  
  This endpoint allows authenticated users to update their password.
  
  ## Security Features
  - Requires current password verification
  - Enforces strong password requirements
  - Invalidates all existing sessions after password change
  - Prevents reusing the current password as the new password
  
  ## Password Requirements
  - Minimum 8 characters
  - At least one uppercase letter
  - At least one lowercase letter  
  - At least one number
  - At least one special character (@$!%*?&)
  
  ## Usage Notes
  - User must be authenticated with a valid access token
  - Current password must be provided for verification
  - New password must meet strength requirements
  - After successful password change, user may need to re-authenticate
  - All existing sessions will be invalidated for security
}