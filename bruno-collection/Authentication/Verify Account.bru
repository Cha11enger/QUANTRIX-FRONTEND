meta {
  name: Verify Account
  type: http
  seq: 2
}

post {
  url: {{baseUrl}}/{{apiVersion}}/auth/verify-account
  body: json
  auth: none
}

headers {
  Content-Type: application/json
  X-Request-ID: {{$guid}}
}

body:json {
  {
    "accountIdentifier": "{{actualuser.accountIdentifier}}"
  }
}

script:pre-request {
  // Pre-request script for Verify Account API
  console.log('‚úÖ Starting Account Verification request...');
  
  // Check if account identifier exists in environment
  const accountId = bru.getEnvVar('actualuser.accountIdentifier');
  
  if (!accountId) {
    console.warn('‚ö†Ô∏è  No account identifier found in environment variables');
    console.warn('üîß Setting default account identifier for testing...');
    
    const defaultAccountId = 'FVMOPWL-BFLRUT8N';
    bru.setEnvVar('actualuser.accountIdentifier', defaultAccountId, { persist: true });
    console.log('üíæ Set default actualuser.accountIdentifier:', defaultAccountId);
  } else {
    console.log('‚úÖ Using account identifier from environment:', accountId);
    
    // Validate account identifier format
    const accountIdPattern = /^[A-Z0-9]{7}-[A-Z0-9]{8}$/;
    if (!accountIdPattern.test(accountId)) {
      console.warn('‚ö†Ô∏è  Account identifier format may be invalid:', accountId);
      console.warn('üìã Expected format: XXXXXXX-XXXXXXXX (7 chars + hyphen + 8 chars)');
    } else {
      console.log('‚úÖ Account identifier format is valid');
    }
  }
  
  // Check if user email exists (for reference)
  const userEmail = bru.getEnvVar('actualuser.email');
  if (userEmail) {
    console.log('üìß Verifying account for email:', userEmail);
  }
  
  console.log('üîç Account verification request prepared successfully');
}

script:post-response {
  // Post-response script for Verify Account API
  console.log('üì• Processing Account Verification response...');
  
  try {
    const responseData = res.getBody();
    console.log('üìä Response status:', res.status);
    
    if (res.status === 200 && responseData.success) {
      console.log('‚úÖ Account verification successful!');
      
      const verificationData = responseData.data;
      
      // Store verification status and details
      bru.setEnvVar('actualuser.isVerified', 'true', { persist: true });
      console.log('üíæ Stored actualuser.isVerified: true');
      
      if (verificationData.accountStatus) {
        bru.setEnvVar('actualuser.accountStatus', verificationData.accountStatus, { persist: true });
        console.log('üíæ Stored actualuser.accountStatus:', verificationData.accountStatus);
      }
      
      if (verificationData.verifiedAt) {
        bru.setEnvVar('actualuser.verifiedAt', verificationData.verifiedAt, { persist: true });
        console.log('üíæ Stored actualuser.verifiedAt:', verificationData.verifiedAt);
      }
      
      // Update last verification time
      bru.setEnvVar('actualuser.lastVerificationTime', new Date().toISOString(), { persist: true });
      
      // Preserve original environment variables that were used/available before verification
      const preserveVars = [
        'accountIdentifier',
        'refreshToken',
        'accessToken',
        'tokenExpiry', 
        'refreshTokenExpiry',
        'username',
        'email',
        'companyName',
        'firstName',
        'lastName',
        'password',
        'confirmPassword',
        'userId',
        'isLoggedIn',
        'lastLoginTime'
      ];

      preserveVars.forEach(varName => {
        const envKey = `actualuser.${varName}`;
        const originalValue = bru.getEnvVar(envKey);
        
        if (originalValue) {
          bru.setEnvVar(envKey, originalValue, { persist: true });
          // Mask sensitive values in logs
          const isSensitive = varName.includes('Token') || varName.includes('password') || varName === 'accessToken';
          console.log(`üíæ Preserved ${envKey}:`, isSensitive ? '***' : originalValue);
        }
      });
      
      console.log('üéâ Account verification completed successfully!');
      console.log('üí° You can now proceed with login using the stored credentials');
      
    } else if (res.status === 400) {
      console.error('‚ùå Account verification failed: Invalid account identifier format');
      console.error('üìÑ Error response:', responseData);
      
      // Store verification failure status
      bru.setEnvVar('actualuser.isVerified', 'false', { persist: true });
      bru.setEnvVar('actualuser.verificationError', 'Invalid account identifier format', { persist: true });
      
      if (responseData.details && responseData.details.errors) {
        console.error('üìù Validation errors:', responseData.details.errors);
      }
      
    } else if (res.status === 404) {
      console.error('‚ùå Account verification failed: Account not found');
      console.error('üìÑ Error response:', responseData);
      
      // Store verification failure status
      bru.setEnvVar('actualuser.isVerified', 'false', { persist: true });
      bru.setEnvVar('actualuser.verificationError', 'Account not found', { persist: true });
      
      console.warn('üí° Please check if the account identifier is correct or if registration was completed');
      
    } else if (res.status === 409) {
      console.log('‚ÑπÔ∏è  Account is already verified');
      console.log('üìÑ Response:', responseData);
      
      // Store verification status (already verified)
      bru.setEnvVar('actualuser.isVerified', 'true', { persist: true });
      bru.setEnvVar('actualuser.accountStatus', 'verified', { persist: true });
      
      // Preserve original environment variables that were used/available before verification
      const preserveVars = [
        'accountIdentifier',
        'refreshToken',
        'accessToken',
        'tokenExpiry', 
        'refreshTokenExpiry',
        'username',
        'email',
        'companyName',
        'firstName',
        'lastName',
        'password',
        'confirmPassword',
        'userId',
        'isLoggedIn',
        'lastLoginTime'
      ];

      preserveVars.forEach(varName => {
        const envKey = `actualuser.${varName}`;
        const originalValue = bru.getEnvVar(envKey);
        
        if (originalValue) {
          bru.setEnvVar(envKey, originalValue, { persist: true });
          // Mask sensitive values in logs
          const isSensitive = varName.includes('Token') || varName.includes('password') || varName === 'accessToken';
          console.log(`üíæ Preserved ${envKey}:`, isSensitive ? '***' : originalValue);
        }
      });
      
      console.log('üí° Account was previously verified, you can proceed with login');
      
    } else if (res.status >= 400) {
      console.error('‚ùå Account verification failed with status:', res.status);
      console.error('üìÑ Error response:', responseData);
      
      // Store verification failure status
      bru.setEnvVar('actualuser.isVerified', 'false', { persist: true });
      
      if (responseData.error) {
        console.error('üö® Error message:', responseData.error);
        bru.setEnvVar('actualuser.verificationError', responseData.error, { persist: true });
      }
    }
    
  } catch (error) {
    console.error('üí• Error processing account verification response:', error.message);
    console.error('üìÑ Raw response:', res.body);
    
    // Store verification failure status on error
    bru.setEnvVar('actualuser.isVerified', 'false', { persist: true });
    bru.setEnvVar('actualuser.verificationError', 'Response processing error', { persist: true });
  }
  
  console.log('üèÅ Account verification response processing completed');
}

docs {
  # Verify Account
  
  This endpoint verifies a user account using the account identifier provided during registration. Account verification is required before users can access protected resources.
  
  ## Request Body
  
  - **accountIdentifier** (string, required): The account identifier in format XXXXXXX-XXXXXXXX
    - Must be exactly 16 characters with a hyphen at position 8
    - Contains uppercase letters and numbers only
    - Example: "FVMOPWL-BFLRUT8N"
  
  ## Account Identifier Format
  
  The account identifier follows this pattern:
  - 7 characters + hyphen + 8 characters
  - Uses uppercase letters (A-Z) and numbers (0-9)
  - Generated automatically during registration
  - Used for account verification and login
  
  ## Success Response (200)
  ```json
  {
    "success": true,
    "data": {
      "message": "Account verified successfully",
      "accountStatus": "verified",
      "verifiedAt": "2025-01-01T00:00:00.000Z"
    },
    "message": "Account verification successful",
    "timestamp": "2025-01-01T00:00:00.000Z"
  }
  ```
  
  ## Error Responses
  
  **400 Bad Request** - Invalid account identifier format:
  ```json
  {
    "success": false,
    "error": "Invalid account identifier format",
    "details": {
      "errors": ["Account identifier must be in format XXXXXXX-XXXXXXXX"]
    },
    "timestamp": "2025-01-01T00:00:00.000Z"
  }
  ```
  
  **404 Not Found** - Account not found:
  ```json
  {
    "success": false,
    "error": "Account not found",
    "timestamp": "2025-01-01T00:00:00.000Z"
  }
  ```
  
  **409 Conflict** - Account already verified:
  ```json
  {
    "success": false,
    "error": "Account is already verified",
    "timestamp": "2025-01-01T00:00:00.000Z"
  }
  ```
  
  **429 Too Many Requests** - Rate limit exceeded
  **500 Internal Server Error** - Server error
}